#Remove the trace-driven obfuscation in Speedball II.
#@author Simon Frankau
#@category _NEW_
#@keybinding 
#@menupath 
#@toolbar 

memory = currentProgram.getMemory()

mask1 = [0x00000000, 0xff000000, 0xffff0000, 0xffffff00, 0xffffffff,
         0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff]
mask2 = [0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
         0xff000000, 0xffff0000, 0xffffff00, 0xffffffff]

# F6 was 33 95 00 00

blah = 0x150fc000

def z(key, addr):
    if key >= 0x80000000:
        key -= 0x80000000    
    memory.setInt(toAddr(addr), key ^ memory.getInt(toAddr(addr)))
    memory.setInt(toAddr(addr + 4), key ^ memory.getInt(toAddr(addr + 4)))
    

def zap(key, addr, next_addr):
    if next_addr - addr > 10:
        printf("Skip at 0x%08x\n", addr)
    if next_addr != 0 and addr < blah:
        len = min(8, next_addr - addr)
    else:
        len = 8
    key1 = key & mask1[len]
    key2 = key & mask2[len]
    # Ghidra wants signed longs.
    if key1 >= 0x80000000:
        key1 -= 0x80000000
    # Ghidra wants signed longs.
    if key2 >= 0x80000000:
        key2 -= 0x80000000
    memory.setInt(toAddr(addr), key1 ^ memory.getInt(toAddr(addr)))
    memory.setInt(toAddr(addr + 4), key2 ^ memory.getInt(toAddr(addr + 4)))

zap(0x2F3C712C, 0x000150F0, 0x000150F6)
zap(0x2F3CDA2C, 0x000150F6, 0x000150FC)
zap(0x2F3C8354, 0x000150FC, 0x00015102)
zap(0x2F3C6C50, 0x00015102, 0x00015104)
zap(0x2F3CD554, 0x00015104, 0x00015106)
zap(0x2F3CBE54, 0x00015106, 0x0001510A)
zap(0x2F3C676F, 0x0001510A, 0x0001510C)
zap(0x2F3CC07A, 0x0001510C, 0x0001510E)
zap(0x2F3CA99F, 0x0001510E, 0x00015112)
zap(0x2F7C12BF, 0x00015112, 0x00015118)

#                             Trace is on!
#        000150f0 5d b9 00        subq.l     #0x6,(trap_trace_vector).l                       = 00000000
#                 00 00 24
#        000150f6 42 b9 00        clr.l      (PTR_00000008).l                                 = 00000000
#                 00 00 08
#        000150fc 42 b9 00        clr.l      (trap_illegal_vector).l                          = 0001509c
#                 00 00 10
#        00015102 4a c4           tas        D4b
#        00015104 44 40           neg.w      D0w
#        00015106 08 03 00 e8     btst.l     -0x18,D3
#        0001510a 5c 4a           addq.w     #0x6,A2
#        0001510c 7a 92           moveq      #-0x6e,D5
#        0001510e 08 c1 00 d6     bset.l     -0x2a,D1
#        00015112 d2 bc 4e        add.l      #0x4e3c4e4d,D1
#                 3c 4e 4d

zap(0x61010C10, 0x00015118, 0x0001511A)
zap(0x2F7CF510, 0x0001511A, 0x0001511C)
zap(0x61015E10, 0x0001511C, 0x0001511E)
zap(0x2F7C0729, 0x0001511E, 0x00015120)
zap(0xFF3ADE5E, 0x00015120, 0x00015128)
zap(0x2F7C877A, 0x00015128, 0x0001512C)
zap(0xFF3A6082, 0x0001512C, 0x0001512E)
zap(0x2F7CC9A6, 0x0001512E, 0x00015130)
zap(0xFF3AB2BA, 0x00015130, 0x00015134)
zap(0x2F7C1BCA, 0x00015134, 0x00015136)
zap(0xFF3AC4EA, 0x00015136, 0x0001513A)
zap(0x2F7CADF5, 0x0001513A, 0x0001513C)
zap(0xFF3A16E4, 0x0001513C, 0x00015142)
zap(0x2F7CFE14, 0x00015142, 0x00015144)
zap(0x00C5E910, 0x00015144, 0x00015146)
zap(0x2F7C5221, 0x00015146, 0x00015148)
zap(0x00C53B35, 0x00015148, 0x0001514E)
zap(0x2F7CE427, 0x0001514E, 0x00015150)
zap(0x00C54D23, 0x00015150, 0x00015156)
zap(0x2F7C362B, 0x00015156, 0x00015158)
zap(0x00C59F57, 0x00015158, 0x0001515C)
zap(0x2F7C7853, 0x0001515C, 0x0001515E)
zap(0x00C52159, 0x0001515E, 0x00015164)
zap(0x2F7C8A68, 0x00015164, 0x00015166)
zap(0x6101E03B, 0x00015166, 0x0001516E)
zap(0x2F7C495B, 0x0001516E, 0x00015172)
zap(0x61013263, 0x00015172, 0x00015174)
zap(0x2F7C9B7F, 0x00015174, 0x00015176)
zap(0x6101447F, 0x00015176, 0x00015178)
zap(0x2F7C2D7F, 0x00015178, 0x0001517A)
zap(0x6101967F, 0x0001517A, 0x0001517C)
zap(0x2F7C7F67, 0x0001517C, 0x0001517E)
zap(0x6101D863, 0x0001517E, 0x00015186)
zap(0xC58E7467, 0x00015186, 0x0001518A)
zap(0x6101F697, 0x0001518A, 0x0001518C)
zap(0xC58E90A7, 0x0001518C, 0x0001518E)
zap(0x610156B3, 0x0001518E, 0x00015190)
zap(0x3A71BDA2, 0x00015190, 0x00015192)
zap(0x6101ADDF, 0x00015192, 0x00015194)
zap(0x3A71A1DF, 0x00015194, 0x0001519A)
zap(0x6101A1AF, 0x0001519A, 0x0001519C)
zap(0x3A71ADB9, 0x0001519C, 0x000151A2)
zap(0x6101BDB3, 0x000151A2, 0x000151A4)
zap(0x3A71A959, 0x000151A4, 0x000151A6)
zap(0x61019951, 0x000151A6, 0x000151A8)
zap(0x3A71AD6A, 0x000151A8, 0x000151AC)
zap(0x6101BCAC, 0x000151AC, 0x000151AE)
zap(0x3A71A2AA, 0x000151AE, 0x000151B0)
zap(0x6101A0B2, 0x000151B0, 0x000151B8)
zap(0x3A71A2DA, 0x000151B8, 0x000151BC)
zap(0x6101ACD2, 0x000151BC, 0x000151BE)
zap(0x3A71BAD2, 0x000151BE, 0x000151C2)
zap(0xBC9F5B2C, 0x000151C2, 0x000151C4)
zap(0x3A710B2C, 0x000151C4, 0x000151CA)
zap(0xBC9FF350, 0x000151CA, 0x000151CC)
zap(0xC58E3ABF, 0x000151CC, 0x000151CE)
zap(0xBC9F4962, 0x000151CE, 0x000151D0)
zap(0xC58E194A, 0x000151D0, 0x000151D6)
zap(0xBC9FCDA2, 0x000151D6, 0x000151D8)
zap(0xC58E3DDC, 0x000151D8, 0x000151E0)
zap(0xBC9F01DC, 0x000151E0, 0x000151E6)
zap(0xC58EC1D4, 0x000151E6, 0x000151E8)
zap(0xBC9F1DD4, 0x000151E8, 0x000151EA)
zap(0xC58E4DD4, 0x000151EA, 0x000151EC)
zap(0xBC9F3954, 0x000151EC, 0x000151F4)
zap(0xC58E097C, 0x000151F4, 0x000151F6)
zap(0xBC9F5D74, 0x000151F6, 0x000151F8)
zap(0xC58E0D74, 0x000151F8, 0x000151FC)
zap(0xBC9FC17C, 0x000151FC, 0x000151FE)
zap(0xC58E4168, 0x000151FE, 0x00015200)
zap(0xBC9F0D3D, 0x00015200, 0x00015202)
zap(0x1708EB22, 0x00015202, 0x00015206)
zap(0xBED64049, 0x00015206, 0x00015208)
zap(0x1708824D, 0x00015208, 0x00015210)
zap(0xBED6CC49, 0x00015210, 0x00015212)
zap(0x17087A51, 0x00015212, 0x00015216)
zap(0xBED68841, 0x00015216, 0x00015218)
zap(0x1708DBCA, 0x00015218, 0x0001521A)
zap(0xBED68BCA, 0x0001521A, 0x0001521E)
zap(0x170843CA, 0x0001521E, 0x00015220)
zap(0xBED6C3CA, 0x00015220, 0x00015222)
zap(0x170883C2, 0x00015222, 0x00015226)
zap(0xBED643CE, 0x00015226, 0x00015228)
zap(0x57088BCE, 0x00015228, 0x0001522E)
zap(0xBED6FBF2, 0x0001522E, 0x00015230)
zap(0x57084BFA, 0x00015230, 0x00015236)
zap(0x293AEDB0, 0x00015236, 0x00015238)
zap(0x57085E71, 0x00015238, 0x0001523A)
zap(0x293A107E, 0x0001523A, 0x0001523C)
zap(0x5708EE6F, 0x0001523C, 0x00015244)
zap(0x293A7C57, 0x00015244, 0x00015246)
zap(0x5C1F743A, 0x00015246, 0x0001524A)
zap(0x293AF23A, 0x0001524A, 0x0001524C)
zap(0x5C1F903A, 0x0001524C, 0x0001524E)
zap(0x293A523A, 0x0001524E, 0x00015250)
zap(0x5C1FF43A, 0x00015250, 0x00015252)
zap(0x293AB724, 0x00015252, 0x00015254)
zap(0x5C1FB724, 0x00015254, 0x00015258)
zap(0x9D810185, 0x00015258, 0x0001525A)
zap(0x5C1FC19E, 0x0001525A, 0x00015260)
zap(0x9D8145E2, 0x00015260, 0x00015262)
zap(0xA3E08C31, 0x00015262, 0x00015264)
zap(0x9D8143FC, 0x00015264, 0x00015266)
zap(0xA3E083E8, 0x00015266, 0x0001526E)
zap(0x5C1FFEF6, 0x0001526E, 0x00015272)
zap(0xA3E0A7EE, 0x00015272, 0x00015278)
zap(0xD5F3BADA, 0x00015278, 0x0001527A)
zap(0xA3E063AD, 0x0001527A, 0x00015280)
zap(0xD5F3CCBC, 0x00015280, 0x00015282)
zap(0xFA4A7392, 0x00015282, 0x0001528A)
zap(0xD5F3DC62, 0x0001528A, 0x0001528C)
zap(0xA3E0B59C, 0x0001528C, 0x00015292)
zap(0xD5F31E64, 0x00015292, 0x00015294)
zap(0xA3E0C770, 0x00015294, 0x00015298)
zap(0xD5F3A068, 0x00015298, 0x0001529A)
zap(0xA3E00940, 0x0001529A, 0x0001529C)
zap(0xD5F3F22B, 0x0001529C, 0x000152A2)
zap(0xA3E05B32, 0x000152A2, 0x000152A4)
zap(0xD5F30402, 0x000152A4, 0x000152A6)
zap(0xA3E0ED12, 0x000152A6, 0x000152A8)
zap(0xD5F35512, 0x000152A8, 0x000152AC)
zap(0xA3E03E07, 0x000152AC, 0x000152AE)
zap(0xD5F3E72F, 0x000152AE, 0x000152B2)
zap(0xA3E04027, 0x000152B2, 0x000152B4)
zap(0xD5F32927, 0x000152B4, 0x000152BA)
zap(0xA3E0922F, 0x000152BA, 0x000152BC)
zap(0xD5F37B2B, 0x000152BC, 0x000152BE)
zap(0xA3E0242F, 0x000152BE, 0x000152C6)
zap(0xD5F38D2F, 0x000152C6, 0x000152C8)
zap(0xA3E0762F, 0x000152C8, 0x000152CA)
zap(0xD5F3DF37, 0x000152CA, 0x000152CC)
zap(0xA3E0B833, 0x000152CC, 0x000152CE)
zap(0xD5F3613F, 0x000152CE, 0x000152D2)
zap(0xA3E0CA3B, 0x000152D2, 0x000152D4)
zap(0xD5F3B33B, 0x000152D4, 0x000152DC)
zap(0xA3E01C4B, 0x000152DC, 0x000152DE)
zap(0xD5F3C543, 0x000152DE, 0x000152E0)
zap(0xA3E0AE7D, 0x000152E0, 0x000152E2)
zap(0xD5F31700, 0x000152E2, 0x000152E4)
zap(0xA3E0F034, 0x000152E4, 0x000152EA)
zap(0x5533D80F, 0x000152EA, 0x000152EC)
zap(0xA3E08117, 0x000152EC, 0x000152EE)
zap(0x3DED797E, 0x000152EE, 0x000152F4)
zap(0x25E4A472, 0x000152F4, 0x000152F6)
zap(0x3DED0D9A, 0x000152F6, 0x000152FC)
zap(0x25E4F28B, 0x000152FC, 0x000152FE)
zap(0x3DED5BA5, 0x000152FE, 0x00015304)
zap(0x25E400DC, 0x00015304, 0x00015306)
zap(0x3DEDE9C0, 0x00015306, 0x0001530A)
zap(0x25E44EC8, 0x0001530A, 0x0001530C)
zap(0x3DED37D4, 0x0001530C, 0x00015310)
zap(0x25E49CD0, 0x00015310, 0x00015312)
zap(0x3DED45F0, 0x00015312, 0x00015314)
zap(0x25E42AE1, 0x00015314, 0x00015316)
zap(0x3DED921D, 0x00015316, 0x0001531E)
zap(0xADE80879, 0x0001531E, 0x00015322)
zap(0x3DED3A79, 0x00015322, 0x00015324)
zap(0xADE84C39, 0x00015324, 0x00015326)
zap(0x3DED0225, 0x00015326, 0x00015328)
zap(0xADE8C029, 0x00015328, 0x0001532C)
zap(0x6964BD78, 0x0001532C, 0x0001532E)
zap(0xADE8CDBE, 0x0001532E, 0x00015334)
zap(0x696499BB, 0x00015334, 0x00015336)
zap(0x52176021, 0x00015336, 0x00015338)
zap(0x6964E6C4, 0x00015338, 0x0001533A)
zap(0xF1D864FB, 0x0001533A, 0x00015340)
zap(0x696466F7, 0x00015340, 0x00015342)
zap(0xF1D8E8F5, 0x00015342, 0x00015348)
zap(0x6964E6C0, 0x00015348, 0x0001534A)
zap(0xF1D8BC4D, 0x0001534A, 0x0001534C)
zap(0x69648E55, 0x0001534C, 0x0001534E)
zap(0xF1D85851, 0x0001534E, 0x00015352)
zap(0x696489BD, 0x00015352, 0x00015354)
zap(0xF1D8BDC8, 0x00015354, 0x0001535C)
zap(0x69644DE3, 0x0001535C, 0x0001535E)
zap(0xF1D881C3, 0x0001535E, 0x00015360)
zap(0x6964C1B7, 0x00015360, 0x00015364)
zap(0xF1D88DBB, 0x00015364, 0x00015366)
zap(0x6964BC46, 0x00015366, 0x0001536A)
zap(0x4D5118DB, 0x0001536A, 0x0001536C)
zap(0x69644EC3, 0x0001536C, 0x00015372)
zap(0x4D513CFF, 0x00015372, 0x00015374)
zap(0x969B031C, 0x00015374, 0x00015376)
zap(0x4D514309, 0x00015376, 0x00015378)
zap(0x969B0B11, 0x00015378, 0x0001537E)
zap(0x4D51FB19, 0x0001537E, 0x00015380)
zap(0x969B4B11, 0x00015380, 0x00015382)
zap(0x4D511B29, 0x00015382, 0x00015386)
zap(0x969BC30D, 0x00015386, 0x00015388)
zap(0x4D51026D, 0x00015388, 0x00015390)
zap(0x969B0095, 0x00015390, 0x00015392)
zap(0x4D51C28D, 0x00015392, 0x00015394)
zap(0x969B1C8D, 0x00015394, 0x00015398)
zap(0x4D514AB5, 0x00015398, 0x000153A0)
zap(0x969BF8BD, 0x000153A0, 0x000153A2)
zap(0x4D510A92, 0x000153A2, 0x000153A6)
zap(0x969B5C9C, 0x000153A6, 0x000153AA)
zap(0x4D510282, 0x000153AA, 0x000153AC)
zap(0x969BC06F, 0x000153AC, 0x000153B4)
zap(0x4D51438F, 0x000153B4, 0x000153B6)
zap(0x969B0231, 0x000153B6, 0x000153B8)
zap(0x4D51DC00, 0x000153B8, 0x000153BC)
zap(0x969B0315, 0x000153BC, 0x000153C2)
zap(0x4D51431D, 0x000153C2, 0x000153C4)
zap(0x969BC311, 0x000153C4, 0x000153C6)
zap(0x4D510B09, 0x000153C6, 0x000153CA)
zap(0x969B5B11, 0x000153CA, 0x000153CC)
zap(0x4D510B19, 0x000153CC, 0x000153D0)
zap(0x969B3B11, 0x000153D0, 0x000153D8)
zap(0x4D514315, 0x000153D8, 0x000153DC)
zap(0x929B0315, 0x000153DC, 0x000153DE)
zap(0x4D51C312, 0x000153DE, 0x000153E0)
zap(0x6CA5942B, 0x000153E0, 0x000153E2)
zap(0x4D51B60B, 0x000153E2, 0x000153E4)
zap(0x6CA5B06B, 0x000153E4, 0x000153E6)
zap(0x4D51960B, 0x000153E6, 0x000153E8)
zap(0x6CA5D41F, 0x000153E8, 0x000153EC)
zap(0x4D51B62F, 0x000153EC, 0x000153EE)
zap(0x6CA5B82C, 0x000153EE, 0x000153F0)
zap(0x4D51B6FD, 0x000153F0, 0x000153F4)
zap(0x6CA0B62B, 0x000153F4, 0x000153F6)
zap(0x4D51B444, 0x000153F6, 0x000153FC)
zap(0x6CA0D66D, 0x000153FC, 0x00015402)
zap(0x4D51904D, 0x00015402, 0x00015408)
zap(0x6CA0B635, 0x00015408, 0x0001540E)
zap(0x4D51B5FD, 0x0001540E, 0x00015414)
zap(0x6CA095C5, 0x00015414, 0x0001541A)
zap(0x4D51562D, 0x0001541A, 0x00015420)
zap(0x6CA08875, 0x00015420, 0x00015426)
zap(0x4D51B67D, 0x00015426, 0x0001542C)
zap(0x6CA0B43D, 0x0001542C, 0x00015432)
zap(0x4D51963D, 0x00015432, 0x00015438)
zap(0x6CA0D0E5, 0x00015438, 0x0001543E)
zap(0x4D51B6CD, 0x0001543E, 0x00015444)
zap(0x6CA0B435, 0x00015444, 0x0001544A)
zap(0x4D51D67D, 0x0001544A, 0x00015450)
zap(0x6CA0987D, 0x00015450, 0x00015456)
zap(0x4D51563D, 0x00015456, 0x0001545C)
zap(0x6CA0B43D, 0x0001545C, 0x00015462)
zap(0x4D51B5FD, 0x00015462, 0x00015468)
zap(0x6CA051FD, 0x00015468, 0x0001546E)
zap(0x4D519025, 0x0001546E, 0x00015478)
zap(0x6CA0B64D, 0x00015478, 0x00015912)
zap(0xB293A700, 0x00015912, 0x00015918)
zap(0xB293A700, 0x00015918, 0x0001591E)
zap(0xB293A700, 0x0001591E, 0x00015924)
zap(0xB293A700, 0x00015924, 0x0001592A)
zap(0xB293A700, 0x0001592A, 0x00015930)
zap(0xB293A700, 0x00015930, 0x00015936)
zap(0xB293A700, 0x00015936, 0x0001593C)
zap(0xB293A700, 0x0001593C, 0x00015942)
zap(0xB293A700, 0x00015942, 0x00015948)
zap(0xB293A700, 0x00015948, 0x0001594E)
zap(0xB293A700, 0x0001594E, 0x00015954)
zap(0xB293A700, 0x00015954, 0x0001595A)
zap(0xB293A700, 0x0001595A, 0x00015960)
zap(0xB293A708, 0x00015960, 0x00015966)
zap(0xB293A708, 0x00015966, 0x0001596C)
zap(0xB293A700, 0x0001596C, 0x00015972)
zap(0xB293A700, 0x00015972, 0x00015978)
zap(0xB293A700, 0x00015978, 0x0001597E)
zap(0xB293A700, 0x0001597E, 0x00015984)
zap(0xB293A700, 0x00015984, 0x0001598A)
zap(0xB293A700, 0x0001598A, 0x00015990)
zap(0xB293A700, 0x00015990, 0x00015996)
zap(0xB293A708, 0x00015996, 0x0001599A)
zap(0xB293A708, 0x0001599A, 0x0001599C)
zap(0xB293A708, 0x0001599C, 0x000159A2)
zap(0xB293A708, 0x000159A2, 0x000159A8)
zap(0xB293A708, 0x000159A8, 0x000159AE)
zap(0xB293A708, 0x000159AE, 0x000159B0)
zap(0xB293A708, 0x000159B0, 0x000159B6)
zap(0xB293A708, 0x000159B6, 0)
